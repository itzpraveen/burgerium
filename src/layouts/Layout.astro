---
import '../styles/global.css';

interface Props {
	title: string;
}

const { title } = Astro.props;
const base = import.meta.env.BASE_URL.replace(/\/$/, '');
---

<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="description" content="Burgerium â€” born from the Burger Tree legacy. Chennai launch with house-baked buns, flame-grilled burgers, and heritage outlets in Palakkad & Coimbatore." />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="theme-color" content="#FAA227" />
		<link rel="icon" type="image/png" href={`${base}/favicon.png`} />
		<meta name="generator" content={Astro.generator} />
		<title>{title}</title>

        <!-- Preconnect for performance -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="preconnect" href="https://cdnjs.cloudflare.com">

        <!-- Preload critical assets -->
        <link rel="preload" href={`${base}/logo.png`} as="image">

        <!-- Google Fonts with display swap -->
        <link href="https://fonts.googleapis.com/css2?family=Anton&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

        <!-- Icons -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

        <noscript>
            <style>
                #preloader { display: none !important; }
            </style>
        </noscript>
	</head>
	<body>
        <!-- Skip to main content for accessibility -->
        <a href="#main-content" class="skip-link">Skip to main content</a>

        <!-- Custom Preloader -->
        <div id="preloader" aria-hidden="true">
            <div class="loader-content">
                <img src={`${base}/logo.png`} alt="" class="loader-logo">
                <div class="loader-bar" role="progressbar" aria-label="Loading"><div class="bar-fill"></div></div>
            </div>
        </div>

        <main id="main-content">
            <slot />
        </main>

        <!-- Lenis Smooth Scroll -->
        <script src="https://cdn.jsdelivr.net/gh/studio-freight/lenis@1.0.29/bundled/lenis.min.js"></script>

        <script>
            const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
            const canHover = window.matchMedia('(hover: hover)').matches;

            if (!prefersReducedMotion) {
                document.documentElement.classList.add('reveal-enabled');
            }

            // PRELOADER LOGIC
            const preloader = document.getElementById('preloader');
            let preloaderHidden = false;

            const hidePreloader = (delay = 0) => {
                if (!preloader || preloaderHidden) return;
                preloaderHidden = true;

                const run = () => {
                    preloader.classList.add('fade-out');
                    setTimeout(() => preloader.style.display = 'none', 500);
                };

                if (delay > 0) {
                    setTimeout(run, delay);
                } else {
                    run();
                }
            };

            if (prefersReducedMotion) {
                hidePreloader();
            } else {
                window.addEventListener('load', () => hidePreloader(500));
                setTimeout(() => hidePreloader(), 3500);
            }

            // SMOOTH SCROLL (LENIS)
            // @ts-ignore
            if (!prefersReducedMotion && typeof Lenis !== 'undefined') {
                // @ts-ignore
                const lenis = new Lenis({
                    duration: 1.2,
                    easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
                    direction: 'vertical',
                    gestureDirection: 'vertical',
                    smooth: true,
                    mouseMultiplier: 1,
                    smoothTouch: false,
                    touchMultiplier: 2,
                });

                function raf(time) {
                    lenis.raf(time);
                    requestAnimationFrame(raf);
                }
                requestAnimationFrame(raf);
            }

            // MAGNETIC BUTTONS
            const btns = document.querySelectorAll('.btn-primary');
            if (canHover && !prefersReducedMotion) {
                btns.forEach((btn) => {
                    btn.addEventListener('mousemove', (e) => {
                        const position = (btn as HTMLElement).getBoundingClientRect();
                        const x = (e as MouseEvent).pageX - position.left - position.width / 2;
                        const y = (e as MouseEvent).pageY - position.top - position.height / 2;

                        (btn as HTMLElement).style.transform = `translate(${x * 0.3}px, ${y * 0.5}px) scale(1.05)`;
                    });

                    btn.addEventListener('mouseout', () => {
                        (btn as HTMLElement).style.transform = 'translate(0px, 0px) scale(1)';
                    });
                });
            }

            // SCROLL REVEAL (Existing logic preserved/enhanced)
            const revealElements = document.querySelectorAll('.scroll-reveal');

            if (!('IntersectionObserver' in window) || prefersReducedMotion) {
                revealElements.forEach((el) => el.classList.add('active'));
            } else {
                const observer = new IntersectionObserver(
                    (entries) => {
                        entries.forEach((entry) => {
                            if (entry.isIntersecting) {
                                entry.target.classList.add('active');
                                observer.unobserve(entry.target);
                            }
                        });
                    },
                    { rootMargin: '0px 0px -10% 0px', threshold: 0 } // Adjusted threshold for tighter reveal
                );
                revealElements.forEach((el) => observer.observe(el));
            }
        </script>

        <style>
            /* Preloader Styles */
            #preloader {
                position: fixed;
                top: 0; left: 0;
                width: 100%; height: 100%;
                background: var(--brand-orange, #FAA227);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 9999;
                transition: opacity 0.5s ease;
            }

            .loader-content {
                text-align: center;
            }

            .loader-logo {
                width: 180px;
                height: auto;
                opacity: 0;
                animation: fadeUp 0.8s forwards;
            }

            .loader-bar {
                width: 200px;
                height: 3px;
                background: rgba(0, 0, 0, 0.2);
                margin: 20px auto 0;
                position: relative;
                overflow: hidden;
                border-radius: 2px;
            }

            .bar-fill {
                position: absolute;
                top: 0; left: 0;
                width: 0%; height: 100%;
                background: #000;
                border-radius: 2px;
                animation: fillBar 1.2s ease-in-out forwards;
            }

            .fade-out {
                opacity: 0;
                pointer-events: none;
            }

            @keyframes fadeUp {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
            }

            @keyframes fillBar {
                0% { width: 0%; }
                100% { width: 100%; }
            }

            /* Scrollbar Hide (Let Lenis handle it visually, optional but clean) */
            html.lenis {
                height: auto;
            }
            .lenis.lenis-smooth {
                scroll-behavior: auto;
            }
            .lenis.lenis-smooth [data-lenis-prevent] {
                overscroll-behavior: contain;
            }
            .lenis.lenis-stopped {
                overflow: hidden;
            }
            .lenis.lenis-scrolling iframe {
                pointer-events: none;
            }
        </style>
	</body>
</html>
